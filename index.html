<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FluencyAI - Ultimate Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { slate: { 850: '#151f32', 900: '#0f172a' } } } }
        }
    </script>
    <link rel="icon" type="image/svg+xml" href="logo.svg">
    
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s ease, color 0.3s ease; }
        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.6); }
        .dark .glass-panel { background: rgba(30, 41, 59, 0.85); border: 1px solid rgba(255, 255, 255, 0.08); }
        .mobile-glass-bar { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(16px); border-top: 1px solid rgba(226, 232, 240, 0.8); }
        .dark .mobile-glass-bar { background: rgba(15, 23, 42, 0.95); border-top: 1px solid rgba(51, 65, 85, 0.8); }
        .pulse-recording { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(225, 29, 72, 0); } 100% { box-shadow: 0 0 0 0 rgba(225, 29, 72, 0); } }
        .topic-card { transition: all 0.2s ease; }
        .topic-card:hover { transform: translateY(-2px); }
        .topic-active { border-left: 4px solid #4f46e5; background-color: #f5f3ff; }
        .dark .topic-active { background-color: rgba(79, 70, 229, 0.15); border-left-color: #818cf8; }
        .topic-done { opacity: 0.6; background-color: #f0fdf4; border-left: 4px solid #22c55e; }
        .dark .topic-done { background-color: rgba(34, 197, 94, 0.1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .tab-btn.active { border-bottom: 2px solid #4f46e5; color: #4f46e5; }
        .dark .tab-btn.active { color: #818cf8; border-bottom-color: #818cf8; }
        .tab-btn { color: #64748b; border-bottom: 2px solid transparent; }
        .dark .tab-btn { color: #94a3b8; }
        .audio-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-indigo-50 to-blue-50 dark:from-slate-950 dark:via-slate-900 dark:to-indigo-950 min-h-screen text-slate-800 dark:text-slate-100 pb-32 lg:pb-0">

    <nav class="w-full glass-panel sticky top-0 z-50 px-4 md:px-6 py-3 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-fire text-orange-500 text-xl md:text-2xl"></i>
            <span class="text-lg md:text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-violet-600 dark:from-indigo-400 dark:to-violet-400">FluencyAI</span>
            <span class="text-[10px] md:text-xs font-mono bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 px-2 py-0.5 rounded-full border border-indigo-200 dark:border-indigo-700" id="levelBadge">Lvl 1</span>
        </div>
        <button id="settingsBtn" class="p-2 text-slate-500 dark:text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">
            <i class="fa-solid fa-gear text-lg"></i>
        </button>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-6 md:py-8 grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
        <div class="lg:col-span-1 space-y-4 md:space-y-6">
            <div class="glass-panel rounded-2xl p-4 md:p-6 shadow-sm flex justify-between items-center">
                <div class="text-center w-1/2">
                    <div class="text-2xl md:text-3xl font-bold text-orange-500 flex items-center gap-1 justify-center">
                        <span id="streakCount">0</span> <i class="fa-solid fa-fire text-sm"></i>
                    </div>
                    <div class="text-[10px] md:text-xs text-slate-500 dark:text-slate-400 uppercase font-semibold mt-1">Day Streak</div>
                </div>
                <div class="h-10 w-px bg-slate-200 dark:bg-slate-700"></div>
                <div class="text-center w-1/2">
                    <div class="text-2xl md:text-3xl font-bold text-indigo-600 dark:text-indigo-400" id="completedCount">0/5</div>
                    <div class="text-[10px] md:text-xs text-slate-500 dark:text-slate-400 uppercase font-semibold mt-1">Today's Goal</div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-4 md:p-5 shadow-sm">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-slate-700 dark:text-slate-200 text-sm md:text-base">Today's Workout</h3>
                    <button id="refreshTopicsBtn" class="text-xs text-slate-400 hover:text-indigo-600 dark:hover:text-indigo-400 flex items-center gap-1"><i class="fa-solid fa-rotate"></i> Refresh</button>
                </div>
                <div id="topicsList" class="space-y-3">
                    <div class="text-center py-8 text-slate-400 text-sm"><i class="fa-solid fa-spinner fa-spin mb-2"></i><br>Loading...</div>
                </div>
                <button id="bonusTopicBtn" class="w-full mt-4 py-3 text-sm text-indigo-600 dark:text-indigo-300 border border-indigo-200 dark:border-indigo-800 rounded-xl hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-colors hidden font-medium">+ Add Bonus Topic</button>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-4 md:space-y-6" id="practiceArea">
            <div class="glass-panel rounded-2xl p-5 md:p-6 shadow-sm border-l-4 border-indigo-500 dark:border-indigo-400">
                <h2 class="text-xs font-bold text-indigo-600 dark:text-indigo-400 uppercase tracking-wide mb-1">Current Topic</h2>
                <h1 id="activeTopicText" class="text-lg md:text-xl font-bold text-slate-800 dark:text-white leading-snug">Select a topic above to start.</h1>
            </div>

            <div id="chatContainer" class="glass-panel rounded-2xl p-4 md:p-6 shadow-sm h-[50vh] lg:h-[500px] overflow-y-auto space-y-6 bg-white/60 dark:bg-slate-900/50 scroll-smooth relative no-scrollbar">
                <div class="text-center text-slate-400 py-20 md:py-32 flex flex-col items-center gap-4">
                    <div class="w-14 h-14 md:w-16 md:h-16 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-microphone-lines text-2xl opacity-50"></i>
                    </div>
                    <p class="text-sm md:text-base px-6">Select a topic, then hold the mic.</p>
                </div>
            </div>

            <div class="fixed bottom-0 left-0 w-full mobile-glass-bar p-4 lg:p-0 lg:static lg:bg-transparent lg:border-none lg:shadow-none z-40 transition-all duration-300">
                <div class="max-w-6xl mx-auto flex flex-col items-center justify-center gap-3">
                    <div id="statusText" class="text-xs font-bold text-indigo-600 dark:text-indigo-300 bg-indigo-50 dark:bg-indigo-900/50 border border-indigo-100 dark:border-indigo-800 px-3 py-1 rounded-full shadow-sm opacity-0 transition-opacity">Listening...</div>
                    <button id="micBtn" class="bg-slate-300 dark:bg-slate-700 text-white w-16 h-16 md:w-20 md:h-20 rounded-full shadow-lg flex items-center justify-center transition-all cursor-not-allowed transform active:scale-95" disabled>
                        <i class="fa-solid fa-microphone text-2xl md:text-3xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="settingsModal" class="fixed inset-0 bg-black/60 z-[70] hidden flex items-center justify-center backdrop-blur-sm px-4">
        <div class="bg-white dark:bg-slate-800 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden flex flex-col max-h-[90vh]" id="modalContent">
            <div class="p-5 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                <h3 class="text-lg font-bold text-slate-800 dark:text-white">Settings</h3>
                <button onclick="document.getElementById('settingsModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="flex border-b border-slate-100 dark:border-slate-700 px-5">
                <button class="tab-btn active px-4 py-3 text-sm font-medium transition-colors" onclick="switchTab('keys')">API Keys</button>
                <button class="tab-btn px-4 py-3 text-sm font-medium transition-colors" onclick="switchTab('backup')">Data</button>
                <button class="tab-btn px-4 py-3 text-sm font-medium transition-colors" onclick="switchTab('theme')">Theme</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div id="tab-keys" class="space-y-4">
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-2">Add up to 5 keys for auto-rotation.</p>
                    <div id="keyList" class="space-y-3"></div>
                    <button onclick="saveKeys()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl shadow-md mt-4">Save Keys</button>
                </div>
                <div id="tab-backup" class="hidden space-y-6">
                    <div class="space-y-3">
                        <h4 class="text-xs font-bold text-slate-500 uppercase">Create Encrypted Backup</h4>
                        <div class="flex items-center">
                            <input type="text" id="backupFilename" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-l-lg px-4 py-2 text-sm dark:text-white" placeholder="filename" value="fluency_backup">
                            <span class="bg-slate-100 dark:bg-slate-600 border border-l-0 border-slate-200 dark:border-slate-500 rounded-r-lg px-3 py-2 text-sm text-slate-500 dark:text-slate-300 font-mono">.fai</span>
                        </div>
                        <input type="password" id="backupPass" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-4 py-2 text-sm dark:text-white" placeholder="Set Password">
                        <button onclick="performBackup()" class="w-full py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg shadow-sm text-sm"><i class="fa-solid fa-download mr-2"></i> Download</button>
                    </div>
                    <div class="h-px bg-slate-200 dark:bg-slate-700"></div>
                    <div class="space-y-3">
                        <h4 class="text-xs font-bold text-slate-500 uppercase">Restore Progress</h4>
                        <input type="file" id="restoreFile" accept=".fai" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 dark:file:bg-slate-700 dark:file:text-slate-200">
                        <input type="password" id="restorePass" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-4 py-2 text-sm dark:text-white" placeholder="Enter Password">
                        <button onclick="performRestore()" class="w-full py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-sm text-sm"><i class="fa-solid fa-rotate-left mr-2"></i> Restore</button>
                    </div>
                </div>
                <div id="tab-theme" class="hidden space-y-4 text-center">
                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Select your preferred appearance.</p>
                    <div class="flex justify-center gap-4">
                        <button onclick="setTheme('light')" class="p-6 rounded-xl border-2 border-slate-200 dark:border-slate-700 hover:border-indigo-500 flex flex-col items-center gap-2 w-32 dark:text-white">
                            <i class="fa-solid fa-sun text-3xl text-orange-400"></i>
                            <span class="text-sm font-bold">Light</span>
                        </button>
                        <button onclick="setTheme('dark')" class="p-6 rounded-xl border-2 border-slate-200 dark:border-slate-700 hover:border-indigo-500 flex flex-col items-center gap-2 w-32 bg-slate-900 text-white">
                            <i class="fa-solid fa-moon text-3xl text-indigo-400"></i>
                            <span class="text-sm font-bold">Dark</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // --- GLOBAL SETTINGS ---
    const MODEL_NAME = "gemini-flash-latest"; // Updated to current stable model name
    
    // --- APP STATE ---
    const todayStr = new Date().toISOString().split('T')[0];
    let appState = {
        apiKeys: JSON.parse(localStorage.getItem('fluency_api_keys')) || ['', '', '', '', ''],
        currentKeyIndex: 0,
        level: parseInt(localStorage.getItem('user_level')) || 1,
        streak: parseInt(localStorage.getItem('user_streak')) || 0,
        lastPractice: localStorage.getItem('last_practice_date') || '',
        dailyTopics: JSON.parse(localStorage.getItem('daily_topics_' + todayStr)) || [],
        completedTopics: JSON.parse(localStorage.getItem('completed_topics_' + todayStr)) || [],
        theme: localStorage.getItem('fluency_theme') || 'light'
    };
    
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let chatSession = null;
    let currentTopicIndex = -1;
    let currentAudio = null; // Track current audio to stop it if needed

    // --- INDEXED DB ---
    const dbName = "FluencyAIDB";
    let db;
    const initDB = () => {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(dbName, 1);
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains('chats')) db.createObjectStore('chats', { keyPath: 'id', autoIncrement: true });
            };
            request.onsuccess = (e) => { db = e.target.result; resolve(db); };
            request.onerror = (e) => reject(e.target.error);
        });
    };
    const saveChatMessage = (topicId, msg) => {
        if (!db) return;
        const tx = db.transaction(['chats'], 'readwrite');
        msg.topicId = topicId; msg.timestamp = Date.now();
        tx.objectStore('chats').add(msg);
    };
    const loadChatHistory = (topicId) => {
        return new Promise((resolve) => {
            if (!db) return resolve([]);
            const tx = db.transaction(['chats'], 'readonly');
            const req = tx.objectStore('chats').getAll();
            req.onsuccess = () => resolve(req.result.filter(m => m.topicId === topicId).sort((a,b) => a.timestamp - b.timestamp));
        });
    };

    // --- THEME ---
    window.setTheme = (mode) => {
        appState.theme = mode;
        localStorage.setItem('fluency_theme', mode);
        if (mode === 'dark') document.documentElement.classList.add('dark');
        else document.documentElement.classList.remove('dark');
    };
    window.setTheme(appState.theme);

    // --- NEW EDGE TTS IMPLEMENTATION ---
    window.speakText = async (text) => {
        // Stop any currently playing audio
        if (currentAudio) {
            currentAudio.pause();
            currentAudio = null;
        }

        // Show visual indicator on the last AI message if possible
        const buttons = document.querySelectorAll('.audio-btn');
        if(buttons.length > 0) {
            const lastBtn = buttons[buttons.length - 1];
            const originalIcon = lastBtn.innerHTML;
            lastBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading';
        }

        try {
            const response = await fetch('/api/tts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    text: text,
                    voice: 'en-US-AriaNeural' // Options: en-US-AriaNeural (Female), en-US-GuyNeural (Male)
                })
            });

            if (!response.ok) throw new Error('TTS API failed');

            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            currentAudio = new Audio(url);
            
            currentAudio.onended = () => {
                URL.revokeObjectURL(url); // Cleanup memory
            };
            
            currentAudio.play();

        } catch (error) {
            console.error("TTS Error, falling back to browser default:", error);
            // Fallback to browser native TTS if API fails
            const utterance = new SpeechSynthesisUtterance(text);
            window.speechSynthesis.speak(utterance);
        } finally {
            // Restore button icons
            if(buttons.length > 0) {
                 buttons[buttons.length - 1].innerHTML = '<i class="fa-solid fa-volume-high"></i> Replay';
            }
        }
    };

    window.playUserAudio = (base64) => {
        if (currentAudio) currentAudio.pause();
        currentAudio = new Audio("data:audio/webm;base64," + base64);
        currentAudio.play();
    };

    // --- CRYPTO ---
    async function deriveKey(pw, salt) {
        const enc = new TextEncoder();
        const km = await window.crypto.subtle.importKey("raw", enc.encode(pw), "PBKDF2", false, ["deriveKey"]);
        return window.crypto.subtle.deriveKey({ name: "PBKDF2", salt: enc.encode(salt), iterations: 100000, hash: "SHA-256" }, km, { name: "AES-GCM", length: 256 }, true, ["encrypt", "decrypt"]);
    }
    async function encryptData(data, pw) {
        const salt = window.crypto.getRandomValues(new Uint8Array(16)).join(',');
        const iv = window.crypto.getRandomValues(new Uint8Array(12));
        const key = await deriveKey(pw, salt);
        const enc = new TextEncoder();
        const encData = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, enc.encode(JSON.stringify(data)));
        return JSON.stringify({ salt: salt, iv: Array.from(iv), data: Array.from(new Uint8Array(encData)) });
    }
    async function decryptData(json, pw) {
        try {
            const pkg = JSON.parse(json);
            const key = await deriveKey(pw, pkg.salt);
            const decData = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: new Uint8Array(pkg.iv) }, key, new Uint8Array(pkg.data));
            return JSON.parse(new TextDecoder().decode(decData));
        } catch (e) { throw new Error("Incorrect password or corrupted file"); }
    }

    // --- MODEL ---
    async function getWorkingModel(systemInstruction = null) {
        const key = appState.apiKeys[appState.currentKeyIndex].trim();
        if(!key) throw new Error("No API Key configured");
        const genAI = new GoogleGenerativeAI(key);
        const modelParams = { model: MODEL_NAME };
        if (systemInstruction) modelParams.systemInstruction = systemInstruction;
        return genAI.getGenerativeModel(modelParams);
    }

    async function rotateKey() {
        for(let i = 1; i < appState.apiKeys.length; i++) {
            const nextIndex = (appState.currentKeyIndex + i) % appState.apiKeys.length;
            if(appState.apiKeys[nextIndex]) {
                appState.currentKeyIndex = nextIndex;
                return true;
            }
        }
        return false;
    }

    // --- UI ---
    window.switchTab = (tab) => {
        ['keys', 'backup', 'theme'].forEach(t => document.getElementById(`tab-${t}`).classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${tab}`).classList.remove('hidden');
        event.target.classList.add('active');
    };

    window.renderKeyInputs = () => {
        const list = document.getElementById('keyList');
        list.innerHTML = '';
        appState.apiKeys.forEach((k, i) => {
            list.innerHTML += `<input type="password" id="key-${i}" value="${k}" class="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg px-4 py-2 text-sm mb-2 dark:text-white" placeholder="API Key #${i+1}">`;
        });
    };

    window.saveKeys = () => {
        const newKeys = [];
        for(let i=0; i<5; i++) newKeys.push(document.getElementById(`key-${i}`).value.trim());
        appState.apiKeys = newKeys;
        localStorage.setItem('fluency_api_keys', JSON.stringify(newKeys));
        document.getElementById('settingsModal').classList.add('hidden');
        initApp();
        alert("Keys Saved!");
    };

    window.performBackup = async () => {
        const pass = document.getElementById('backupPass').value;
        const fname = document.getElementById('backupFilename').value || 'fluency_backup';
        if(!pass) return alert("Please enter a password");
        saveState(); 
        const backupObj = { ...appState, timestamp: Date.now() };
        try {
            const encrypted = await encryptData(backupObj, pass);
            const blob = new Blob([encrypted], {type: "text/plain"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${fname}.fai`;
            a.click();
        } catch(e) { alert("Backup failed: " + e.message); }
    };

    window.performRestore = async () => {
        const file = document.getElementById('restoreFile').files[0];
        const pass = document.getElementById('restorePass').value;
        if(!file || !pass) return alert("Please select file and enter password");

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const restoredState = await decryptData(e.target.result, pass);
                if(restoredState.apiKeys) localStorage.setItem('fluency_api_keys', JSON.stringify(restoredState.apiKeys));
                if(restoredState.level !== undefined) localStorage.setItem('user_level', restoredState.level);
                if(restoredState.streak !== undefined) localStorage.setItem('user_streak', restoredState.streak);
                if(restoredState.lastPractice !== undefined) localStorage.setItem('last_practice_date', restoredState.lastPractice);
                
                if(restoredState.dailyTopics && restoredState.dailyTopics.length > 0) {
                    localStorage.setItem('daily_topics_' + todayStr, JSON.stringify(restoredState.dailyTopics));
                }
                if(restoredState.completedTopics) {
                    localStorage.setItem('completed_topics_' + todayStr, JSON.stringify(restoredState.completedTopics));
                }

                appState.apiKeys = restoredState.apiKeys || appState.apiKeys;
                appState.level = restoredState.level || 1;
                appState.streak = restoredState.streak || 0;
                appState.lastPractice = restoredState.lastPractice || '';
                appState.dailyTopics = restoredState.dailyTopics || [];
                appState.completedTopics = restoredState.completedTopics || [];
                
                updateStatsUI();
                renderTopicsList();
                alert("Restore Successful!");
                document.getElementById('settingsModal').classList.add('hidden');
            } catch(err) { alert("Restore Failed: Incorrect Password or Corrupt File."); }
        };
        reader.readAsText(file);
    };

    // --- CORE ---
    function initApp() {
        renderKeyInputs();
        initDB(); 
        const firstKey = appState.apiKeys[0].trim();
        if (!firstKey) {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('topicsList').innerHTML = '<div class="text-center py-8 text-slate-400">Please enter API Key in settings.</div>';
        } else {
            checkStreakLogic();
            loadDailyTopics();
        }
        updateStatsUI();
    }

    function checkStreakLogic() {
        if (appState.lastPractice && appState.lastPractice !== todayStr) {
            const lastDate = new Date(appState.lastPractice);
            const today = new Date(todayStr);
            const diffTime = Math.abs(today - lastDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            if (diffDays > 1) appState.streak = 0;
        }
    }

    function incrementStreak() {
        if (appState.lastPractice !== todayStr) {
            appState.streak++;
            appState.lastPractice = todayStr;
            if (appState.streak % 5 === 0) appState.level++;
            saveState();
            updateStatsUI();
        }
    }

    function saveState() {
        localStorage.setItem('user_level', appState.level);
        localStorage.setItem('user_streak', appState.streak);
        localStorage.setItem('last_practice_date', appState.lastPractice);
        localStorage.setItem('daily_topics_' + todayStr, JSON.stringify(appState.dailyTopics));
        localStorage.setItem('completed_topics_' + todayStr, JSON.stringify(appState.completedTopics));
    }

    function updateStatsUI() {
        document.getElementById('streakCount').innerText = appState.streak;
        document.getElementById('completedCount').innerText = `${appState.completedTopics.length}/5`;
        document.getElementById('levelBadge').innerText = `Lvl ${appState.level}`;
    }

    // --- AI LOGIC ---
    async function generateDailyTopics() {
        const listEl = document.getElementById('topicsList');
        listEl.innerHTML = '<div class="text-center py-8 text-slate-400"><i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i><br>Creating Workout...</div>';

        const runGen = async () => {
            const model = await getWorkingModel();
            const levelContext = appState.level < 5 ? "Beginner" : appState.level < 15 ? "Intermediate" : "Advanced";
            const prompt = `Generate 5 distinct, engaging English conversation topics for a ${levelContext} student. Return ONLY topics separated by pipe (|). No numbering.`;
            const result = await model.generateContent(prompt);
            return result.response.text().split('|').map(t => t.trim()).filter(t => t).slice(0, 5);
        };

        try {
            let topics;
            try { topics = await runGen(); } 
            catch(e) { 
                if(e.message.includes('429') && await rotateKey()) topics = await runGen();
                else throw e;
            }
            if (topics?.length > 0) {
                appState.dailyTopics = topics;
                saveState();
                renderTopicsList();
            }
        } catch (error) {
            console.error(error);
            listEl.innerHTML = `<div class="text-center py-8 text-slate-400"><p class="mb-2 text-sm">Could not load topics.</p><button onclick="generateDailyTopics()" class="text-indigo-600 font-bold underline text-sm hover:text-indigo-800">Retry</button></div>`;
        }
    }

    function renderTopicsList() {
        const listEl = document.getElementById('topicsList');
        listEl.innerHTML = '';
        
        if (appState.dailyTopics.length === 0) {
             listEl.innerHTML = '<div class="text-center py-8 text-slate-400"><button onclick="generateDailyTopics()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm shadow-sm hover:bg-indigo-700">Generate Topics</button></div>';
             return;
        }

        appState.dailyTopics.forEach((topic, index) => {
            const isDone = appState.completedTopics.includes(index);
            const isActive = currentTopicIndex === index;
            const div = document.createElement('div');
            div.className = `topic-card p-4 rounded-xl border border-slate-100 dark:border-slate-700 cursor-pointer flex items-center gap-3 shadow-sm bg-white dark:bg-slate-800 active:bg-slate-50 ${isActive ? 'topic-active' : ''} ${isDone ? 'topic-done' : ''}`;
            div.innerHTML = `<div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${isDone ? 'bg-green-100 text-green-600' : 'bg-slate-100 dark:bg-slate-700 text-slate-400'}"><i class="fa-solid ${isDone ? 'fa-check' : 'fa-play text-xs'}"></i></div><div class="flex-grow text-sm font-medium text-slate-700 dark:text-slate-200 leading-tight">${topic}</div>`;
            div.onclick = () => selectTopic(index);
            listEl.appendChild(div);
        });
        if (appState.completedTopics.length >= 5) document.getElementById('bonusTopicBtn').classList.remove('hidden');
    }

    async function loadDailyTopics() {
        if (appState.dailyTopics.length === 0) {
            await generateDailyTopics();
        } else {
            renderTopicsList();
        }
    }

    async function selectTopic(index) {
        currentTopicIndex = index;
        document.getElementById('activeTopicText').innerText = appState.dailyTopics[index];
        renderTopicsList();
        document.getElementById('micBtn').disabled = false;
        document.getElementById('micBtn').classList.remove('bg-slate-300', 'cursor-not-allowed');
        document.getElementById('micBtn').classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'cursor-pointer');
        
        if (window.innerWidth < 1024) document.getElementById('practiceArea').scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        document.getElementById('chatContainer').innerHTML = '';
        
        const topicKey = `${todayStr}_${index}`;
        const history = await loadChatHistory(topicKey);
        
        if(history.length > 0) {
            history.forEach(msg => addMessage(msg.text, msg.sender, false, msg.audio));
        } else {
           const div = document.createElement('div');
           div.className = "text-center text-slate-400 py-20 md:py-32 flex flex-col items-center gap-4";
           div.innerHTML = `<div class="w-14 h-14 md:w-16 md:h-16 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center"><i class="fa-solid fa-microphone-lines text-2xl opacity-50"></i></div><p class="text-sm md:text-base px-6">Select a topic, then hold the mic.</p>`;
           document.getElementById('chatContainer').appendChild(div);
        }

        startChatSession();
    }

    async function startChatSession() {
        try {
            const instruction = `Tutor for topic: "${appState.dailyTopics[currentTopicIndex]}". 1. Listen. 2. Reply properly (as a teacher). 3. Mention all improvement.`;
            const model = await getWorkingModel(instruction);
            chatSession = model.startChat();
        } catch(e) { console.error("Chat Init Error", e); }
    }

    async function toggleRecording() {
        if (!isRecording) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                audioChunks = [];
                mediaRecorder.ondataavailable = e => e.data.size > 0 && audioChunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    if (blob.size < 1000) return addMessage("Too short.", 'ai', true);
                    
                    const url = URL.createObjectURL(blob);
                    
                    await processAudio(blob);
                    
                    if (!appState.completedTopics.includes(currentTopicIndex)) {
                        appState.completedTopics.push(currentTopicIndex);
                        incrementStreak(); saveState(); updateStatsUI(); renderTopicsList();
                    }
                    stream.getTracks().forEach(t => t.stop());
                };
                mediaRecorder.start();
                isRecording = true;
                document.getElementById('micBtn').innerHTML = '<i class="fa-solid fa-stop text-2xl md:text-3xl"></i>';
                document.getElementById('micBtn').classList.add('bg-rose-600', 'pulse-recording');
                document.getElementById('statusText').classList.remove('opacity-0');
            } catch (e) { alert("Mic Error"); }
        } else {
            mediaRecorder.stop();
            isRecording = false;
            document.getElementById('micBtn').innerHTML = '<i class="fa-solid fa-microphone text-2xl md:text-3xl"></i>';
            document.getElementById('micBtn').classList.remove('bg-rose-600', 'pulse-recording');
            document.getElementById('statusText').classList.add('opacity-0');
        }
    }

    async function processAudio(blob) {
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = async () => {
            const base64 = reader.result.split(',')[1];
            
            const topicKey = `${todayStr}_${currentTopicIndex}`;
            saveChatMessage(topicKey, { sender: 'user', text: 'ðŸŽ¤ [Audio Sent]', audio: base64 });
            addMessage("ðŸŽ¤ [Audio Sent]", 'user', false, base64);

            const runChat = async () => {
                if(!chatSession) await startChatSession();
                const res = await chatSession.sendMessage([{ inlineData: { mimeType: "audio/webm", data: base64 } }, { text: "Reply." }]);
                return res.response.text().replace(/\*\*/g, "");
            };
            try {
                try {
                    const text = await runChat();
                    saveChatMessage(topicKey, { sender: 'ai', text: text });
                    addMessage(text, 'ai');
                    speakText(text); 
                } catch(e) {
                    if(e.message.includes('429') && await rotateKey()) {
                        chatSession = null;
                        const text = await runChat();
                        saveChatMessage(topicKey, { sender: 'ai', text: text });
                        addMessage(text, 'ai');
                        speakText(text); 
                    } else throw e;
                }
            } catch(e) { addMessage("Error: " + e.message, 'ai', true); }
        };
    }

    function addMessage(text, sender, isError, audioBase64 = null) {
        if (document.querySelector('#chatContainer .text-center')) {
            document.getElementById('chatContainer').innerHTML = '';
        }

        const div = document.createElement('div');
        div.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} mb-4 animate-fade-in`;
        
        let contentHTML = text;
        let extraControls = '';

        if (sender === 'user' && audioBase64) {
           extraControls = `<button onclick="playUserAudio('${audioBase64}')" class="ml-2 w-8 h-8 rounded-full bg-indigo-500 hover:bg-indigo-600 flex items-center justify-center text-white audio-btn"><i class="fa-solid fa-play text-xs"></i></button>`;
           contentHTML = `<div class="flex items-center"><span>${text}</span>${extraControls}</div>`;
        }
        
        if (sender === 'ai' && !isError) {
            // --- FIX START ---
            // 1. Escape Quotes: So ' or " don't break the HTML
            // 2. Remove Newlines: Replace \n with space so it doesn't break the JS
            const safeText = text
                .replace(/'/g, "\\'")
                .replace(/"/g, '&quot;')
                .replace(/\n/g, ' ')  // <--- This fixes the "unescaped line break" error
                .replace(/\r/g, ''); 
            
            extraControls = `<button onclick="speakText('${safeText}')" class="mt-2 text-indigo-200 hover:text-white text-xs flex items-center gap-1 audio-btn"><i class="fa-solid fa-volume-high"></i> Replay</button>`;
            // --- FIX END ---
        }

        div.innerHTML = `<div class="${sender === 'user' ? 'bg-indigo-600 text-white' : (isError ? 'bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 border border-red-200 dark:border-red-800' : 'bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200')} px-4 py-3 rounded-2xl max-w-[85%] shadow-sm text-sm">
                            ${contentHTML}
                            ${sender === 'ai' && !isError ? extraControls : ''}
                         </div>`;
        
        document.getElementById('chatContainer').appendChild(div);
        document.getElementById('chatContainer').scrollTop = 99999;
    }

    document.getElementById('micBtn').addEventListener('click', toggleRecording);
    document.getElementById('settingsBtn').addEventListener('click', () => {
        document.getElementById('settingsModal').classList.remove('hidden');
        renderKeyInputs();
    });
    document.getElementById('refreshTopicsBtn').addEventListener('click', () => confirm("Refresh?") && generateDailyTopics());
    document.getElementById('bonusTopicBtn').addEventListener('click', () => { appState.dailyTopics.push("Bonus Topic"); renderTopicsList(); });
    
    const s = document.createElement('style');
    s.textContent = `.animate-fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); } @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }`;
    document.head.appendChild(s);
    
    // Auto-init on load
    initApp();
</script>
</body>
</html>